<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JSON Челлендж-редактор</title>
  <style>
    body { font-family: Inter, Arial, sans-serif; background: #f8fafc; margin: 0; padding: 0;}
    .container { max-width: 700px; margin: 30px auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 20px #0001; padding: 32px 24px; }
    h1 { font-size: 2rem; margin-bottom: 20px;}
    label { font-weight: 600; margin-bottom: 6px; display: block; }
    input, select, textarea { width: 100%; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px; margin-bottom: 18px; font-size: 1rem;}
    textarea { min-height: 48px; }
    .multi-list { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 18px;}
    .multi-item { border: 1px solid #d1d5db; background: #f3f4f6; border-radius: 16px; padding: 3px 10px; font-size: 0.96rem;}
    .multi-checkbox { margin-right: 5px; }
    .btn { background: #2463eb; color: #fff; border: none; border-radius: 9px; padding: 10px 22px; font-weight: 600; cursor: pointer; font-size: 1.1rem; margin-top: 6px;}
    .btn[disabled] { opacity: 0.4; cursor: default; }
    .btn-secondary { background: #fff; color: #2463eb; border: 1.5px solid #2463eb;}
    .row { display: flex; gap: 18px;}
    .col { flex: 1; }
    @media (max-width: 700px) {
      .container { padding: 16px 4vw; }
    }
  </style>
</head>
<body>
<div id="root"></div>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script>
const { useRef, useState } = React;

// Все варианты пиклистов
const CATEGORIES = [
  { value: "challenge", label: "Челлендж" },
  { value: "action", label: "Action" },
  { value: "truth", label: "Truth" }
];
const COUNTRIES = [
  { value: "US", label: "США" },
  { value: "RU", label: "Россия" },
  { value: "UK", label: "Великобритания" }
];
const LANGS = [
  { value: "ru", label: "Русский" },
  { value: "en", label: "English" }
];

// UUID генератор (RFC4122, v4)
function uuidv4() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );
}

// MultiPicklist компонент
function MultiPicklist({options, values, onChange}) {
  const handleToggle = val => {
    if (values.includes(val)) onChange(values.filter(v => v !== val));
    else onChange([...values, val]);
  };
  return (
    <div className="multi-list">
      {options.map(opt =>
        <label className="multi-item" key={opt.value}>
          <input
            className="multi-checkbox"
            type="checkbox"
            checked={values.includes(opt.value)}
            onChange={() => handleToggle(opt.value)}
          />
          {opt.label}
        </label>
      )}
    </div>
  );
}

function App() {
  const [data, setData] = useState(null);
  const fileInput = useRef();

  // Функции для изменения state
  const handleField = (field, value) => setData({...data, [field]: value});
  const handleEligibility = (field, value) => setData({...data, eligibility: {...data.eligibility, [field]: value}});
  const handleLocaleText = value => setData({...data, locale_text: {ru: value}});
  const handleAbVariants = value => setData({...data, ab_variants_by_locale: {ru: value.split('\n').filter(Boolean)}});
  const handleSeasonality = (field, value) =>
    setData({...data, seasonality: {...data.seasonality, [field]: value}});
  const handlePaywall = (field, value) =>
    setData({...data, paywall: {...data.paywall, [field]: value}});
  const handleTags = (field, value) =>
    setData({...data, tags: {...data.tags, [field]: value.split(',').map(s => s.trim()).filter(Boolean)}});

  // Загрузка файла
  const handleFile = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        let obj = JSON.parse(evt.target.result);
        if (!obj.id) obj.id = uuidv4();
        setData(obj);
      } catch {
        alert("Файл невалидный JSON");
      }
    };
    reader.readAsText(file);
  };

  // Скачивание файла
  const handleSave = () => {
    if (!data.id) data.id = uuidv4();
    const out = JSON.stringify(data, null, 2);
    const blob = new Blob([out], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "challenge.json";
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // Стартовая кнопка
  if (!data) return (
    <div className="container" style={{textAlign:'center'}}>
      <h1>Редактор JSON челленджа</h1>
      <input
        type="file"
        accept=".json,application/json"
        style={{marginBottom: 16}}
        ref={fileInput}
        onChange={handleFile}
      />
      <div style="margin:16px 0 0 0;">
        <button className="btn btn-secondary"
          onClick={() => {
            setData({
              id: uuidv4(),
              catalog_id: "",
              set_id: "",
              category: "challenge",
              call_to_action: { primary: "", secondary: "" },
              depth: 2,
              spice: 0,
              consent_required_level: 0,
              weight: 1,
              target_player: "",
              locale_text: { ru: "" },
              ab_variants_by_locale: { ru: [] },
              tags: { tone: [], occasion: [], season: [], segment: [] },
              eligibility: { countries_allow: [], languages: [], min_age: 0 },
              seasonality: { start_utc: "", end_utc: "", boost_weight: 0 },
              nsfw_light: false,
              nsfw_18_plus: false,
              content_warnings: [],
              paywall: { gated: false, tier: null },
              status: "",
              version: 1,
              author: "",
              reviewer: "",
              created_at: "",
              updated_at: "",
              placeholders: [],
              notes: ""
            });
          }}
        >Создать новый</button>
      </div>
    </div>
  );

  // Рендер формы
  return (
    <div className="container">
      <h1>Редактор JSON челленджа</h1>
      <label>Категория</label>
      <select
        value={data.category}
        onChange={e => handleField("category", e.target.value)}
      >
        {CATEGORIES.map(opt =>
          <option key={opt.value} value={opt.value}>{opt.label}</option>
        )}
      </select>

      <label>Текст задания (ru)</label>
      <input
        value={data.locale_text?.ru || ""}
        onChange={e => handleLocaleText(e.target.value)}
      />

      <label>AB варианты (ru, каждый вариант с новой строки)</label>
      <textarea
        value={data.ab_variants_by_locale?.ru?.join('\n') || ""}
        onChange={e => handleAbVariants(e.target.value)}
      />

      <label>Разрешённые страны</label>
      <MultiPicklist
        options={COUNTRIES}
        values={data.eligibility.countries_allow || []}
        onChange={vals => handleEligibility("countries_allow", vals)}
      />

      <label>Языки</label>
      <MultiPicklist
        options={LANGS}
        values={data.eligibility.languages || []}
        onChange={vals => handleEligibility("languages", vals)}
      />

      <label>Минимальный возраст</label>
      <input
        type="number"
        min="0"
        value={data.eligibility.min_age}
        onChange={e => handleEligibility("min_age", parseInt(e.target.value) || 0)}
      />

      <label>Дата начала (UTC)</label>
      <input
        type="datetime-local"
        value={data.seasonality.start_utc ? data.seasonality.start_utc.slice(0,16) : ""}
        onChange={e => handleSeasonality("start_utc", e.target.value)}
      />
      <label>Дата конца (UTC)</label>
      <input
        type="datetime-local"
        value={data.seasonality.end_utc ? data.seasonality.end_utc.slice(0,16) : ""}
        onChange={e => handleSeasonality("end_utc", e.target.value)}
      />

      <div className="row">
        <div className="col">
          <label>Вес</label>
          <input
            type="number"
            min="0"
            value={data.weight}
            onChange={e => handleField("weight", parseInt(e.target.value) || 0)}
          />
        </div>
        <div className="col">
          <label>Spice</label>
          <input
            type="number"
            min="0"
            value={data.spice}
            onChange={e => handleField("spice", parseInt(e.target.value) || 0)}
          />
        </div>
      </div>

      <label>Подсказки (tone, через запятую)</label>
      <input
        value={data.tags.tone.join(', ')}
        onChange={e => handleTags("tone", e.target.value)}
      />

      <label>Сегменты (segment, через запятую)</label>
      <input
        value={data.tags.segment.join(', ')}
        onChange={e => handleTags("segment", e.target.value)}
      />

      <label>Сезон (season, через запятую)</label>
      <input
        value={data.tags.season.join(', ')}
        onChange={e => handleTags("season", e.target.value)}
      />

      <label>Поводы (occasion, через запятую)</label>
      <input
        value={data.tags.occasion.join(', ')}
        onChange={e => handleTags("occasion", e.target.value)}
      />

      <label>Call To Action (primary)</label>
      <input
        value={data.call_to_action.primary}
        onChange={e => setData({...data, call_to_action: {...data.call_to_action, primary: e.target.value}})}
      />

      <label>Call To Action (secondary)</label>
      <input
        value={data.call_to_action.secondary}
        onChange={e => setData({...data, call_to_action: {...data.call_to_action, secondary: e.target.value}})}
      />

      <label>Статус</label>
      <input
        value={data.status}
        onChange={e => handleField("status", e.target.value)}
      />

      <label>Notes</label>
      <textarea
        value={data.notes}
        onChange={e => handleField("notes", e.target.value)}
      />

      <div style="margin:22px 0 12px 0">
        <button className="btn" onClick={handleSave}>Скачать JSON</button>
        <button className="btn btn-secondary" style="margin-left:14px"
          onClick={() => fileInput.current.click()}>Загрузить другой файл</button>
        <input type="file" style="display:none" ref={fileInput} onChange={handleFile}/>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
