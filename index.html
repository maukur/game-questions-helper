<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>JSON Editor</title>
<style>
body{font-family:Arial, sans-serif;margin:20px;}
input,select,button,textarea{margin:4px 0;padding:4px;font-size:14px;}
fieldset{border:1px solid #ccc;padding:10px;margin-bottom:10px;}
details{border:1px solid #999;padding:6px;margin-bottom:8px;border-radius:4px;}
summary{font-weight:bold;cursor:pointer;}
label{display:block;margin-top:6px;}
.multi-select{min-width:200px;min-height:80px;}
</style>
</head>
<body>

<h2>JSON Editor</h2>

<input type="file" id="fileInput" accept=".json">
<button id="downloadBtn" disabled>Сохранить файл</button>
<div id="editor"></div>

<script>
(function(){
  let jsonData = [];
  const fileInput = document.getElementById('fileInput');
  const downloadBtn = document.getElementById('downloadBtn');
  const editorDiv = document.getElementById('editor');

  fileInput.addEventListener('change', handleFileSelect);
  downloadBtn.addEventListener('click', downloadFile);

  function handleFileSelect(evt){
    const file = evt.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        jsonData = JSON.parse(e.target.result);
        if(!Array.isArray(jsonData)){
          jsonData = [jsonData];
        }
        renderEditor();
        downloadBtn.disabled = false;
      }catch(err){
        alert('Неверный JSON: '+err.message);
      }
    };
    reader.readAsText(file,'utf-8');
  }

  function renderEditor(){
    editorDiv.innerHTML = '';
    jsonData.forEach((item, idx)=>{
      if(!item.id || !isUUID(item.id)){
        item.id = crypto.randomUUID();
      }
      const container = document.createElement('details');
      container.open = true;
      const summary = document.createElement('summary');
      summary.textContent = 'Элемент '+(idx+1)+' — '+item.id;
      container.appendChild(summary);

      const form = document.createElement('div');
      buildForm(item, form, (path,val)=>updateJson(idx, path, val));
      container.appendChild(form);
      editorDiv.appendChild(container);
    });
  }

  function buildForm(obj, parent, onChange, prefix=''){
    Object.entries(obj).forEach(([key, value])=>{
      const path = prefix? prefix+'.'+key : key;
      const label = document.createElement('label');
      label.textContent = key;
      parent.appendChild(label);

      if(Array.isArray(value) && value.every(v=>typeof v==='string')){
        const select = document.createElement('select');
        select.multiple = true;
        select.className='multi-select';
        const options = [...new Set(value)];
        options.forEach(opt=>{
          const option = document.createElement('option');
          option.value = opt;
          option.selected = true;
          option.textContent = opt;
          select.appendChild(option);
        });
        select.addEventListener('change',()=>{
          const selected = Array.from(select.selectedOptions).map(o=>o.value);
          onChange(path,selected);
        });
        parent.appendChild(select);
      }else if(typeof value==='string'){
        if(key==='category'){
          const select = document.createElement('select');
          const categories = ['challenge','truth','dare','question'];
          categories.forEach(cat=>{
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            if(cat===value) option.selected = true;
            select.appendChild(option);
          });
          select.addEventListener('change',()=>onChange(path,select.value));
          parent.appendChild(select);
        }else if(isIsoDate(value)){
          const input = document.createElement('input');
          input.type='datetime-local';
          input.value = isoToLocal(value);
          input.addEventListener('input',()=>onChange(path,localToIso(input.value)));
          parent.appendChild(input);
        }else{
          const input = document.createElement('input');
          input.type='text';
          input.value=value;
          if(key==='id') input.disabled=true;
          input.addEventListener('input',()=>onChange(path,input.value));
          parent.appendChild(input);
        }
      }else if(typeof value==='number'){
        const input = document.createElement('input');
        input.type='number';
        input.value=value;
        input.addEventListener('input',()=>onChange(path,Number(input.value)));
        parent.appendChild(input);
      }else if(typeof value==='boolean'){
        const input = document.createElement('input');
        input.type='checkbox';
        input.checked=value;
        input.addEventListener('change',()=>onChange(path,input.checked));
        parent.appendChild(input);
      }else if(typeof value==='object' && value!==null){
        const fieldset = document.createElement('fieldset');
        buildForm(value, fieldset, onChange, path);
        parent.appendChild(fieldset);
      }else{
        const textarea = document.createElement('textarea');
        textarea.value = JSON.stringify(value);
        textarea.addEventListener('input',()=>{
          try{
            onChange(path,JSON.parse(textarea.value));
            textarea.style.borderColor='';
          }catch{
            textarea.style.borderColor='red';
          }
        });
        parent.appendChild(textarea);
      }
    });
  }

  function updateJson(idx, path, newVal){
    const keys = path.split('.');
    let ref = jsonData[idx];
    for(let i=0;i<keys.length-1;i++){
      ref = ref[keys[i]];
    }
    ref[keys[keys.length-1]] = newVal;
  }

  function downloadFile(){
    const blob = new Blob([JSON.stringify(jsonData,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;
    a.download='edited.json';
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(url);
    document.body.removeChild(a);
  }

  function isIsoDate(str){
    return /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$/.test(str);
  }
  function isoToLocal(iso){
    const d = new Date(iso);
    return d.toISOString().slice(0,16);
  }
  function localToIso(local){
    return new Date(local).toISOString();
  }
  function isUUID(str){
    return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(str);
  }
})();
</script>
</body>
</html>
