<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON Editor</title>
<style>
:root{
  --bg:#f5f7fa;
  --card-bg:#ffffff;
  --primary:#0066ff;
  --primary-hover:#004cc7;
  --border:#e0e6ef;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,.08);
  --font:"Segoe UI", "SF Pro", Roboto, Helvetica, Arial, sans-serif;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:var(--bg);
  font-family:var(--font);
  color:#1f2937;
  line-height:1.4;
  padding:24px;
}
h1{
  font-size:28px;
  margin-bottom:16px;
}
button,input,select,textarea{
  font-family:inherit;
  font-size:14px;
}
button{
  background:var(--primary);
  color:#fff;
  border:none;
  padding:8px 18px;
  border-radius:var(--radius);
  cursor:pointer;
  transition:background .2s;
}
button[disabled]{
  opacity:.4;
  cursor:not-allowed;
}
button:not([disabled]):hover{
  background:var(--primary-hover);
}
#controls{
  display:flex;
  gap:12px;
  margin-bottom:20px;
  flex-wrap:wrap;
}
.card{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
  margin-bottom:16px;
}
summary{
  list-style:none;
  position:relative;
  padding-left:20px;
  cursor:pointer;
}
summary::before{content:"▶";position:absolute;left:0;transition:transform .2s;}
[open]>summary::before{transform:rotate(90deg);} 
label{
  display:block;
  font-weight:600;
  margin:12px 0 4px;
}
input[type="text"],input[type="number"],input[type="datetime-local"],select,textarea{
  width:100%;
  padding:8px 10px;
  border:1px solid var(--border);
  border-radius:var(--radius);
  background:#fdfdfd;
  transition:border-color .2s;
}
input:focus,select:focus,textarea:focus{
  border-color:var(--primary);
  outline:none;
}
.multi-select{
  min-height:120px;
}
fieldset{
  border:none;
  padding:0;
}
@media (min-width:600px){
  .grid-two{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:20px;
  }
}
</style>
</head>
<body>
  <h1>JSON Editor</h1>
  <div id="controls">
    <input type="file" id="fileInput" accept=".json">
    <button id="downloadBtn" disabled>Сохранить файл</button>
  </div>
  <div id="editor"></div>

<script>
(function(){
  let jsonData = [];
  const fileInput = document.getElementById('fileInput');
  const downloadBtn = document.getElementById('downloadBtn');
  const editorDiv = document.getElementById('editor');

  fileInput.addEventListener('change', handleFileSelect);
  downloadBtn.addEventListener('click', downloadFile);

  function handleFileSelect(evt){
    const file = evt.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        jsonData = JSON.parse(e.target.result);
        if(!Array.isArray(jsonData)) jsonData = [jsonData];
        renderEditor();
        downloadBtn.disabled = false;
      }catch(err){
        alert('Неверный JSON: '+err.message);
      }
    };
    reader.readAsText(file,'utf-8');
  }

  function renderEditor(){
    editorDiv.innerHTML = '';
    jsonData.forEach((item, idx)=>{
      if(!item.id || !isUUID(item.id)) item.id = crypto.randomUUID();
      const details = document.createElement('details');
      details.className='card';
      details.open = true;
      const summary = document.createElement('summary');
      summary.textContent = `Элемент ${idx+1} — ${item.id}`;
      details.appendChild(summary);
      const form = document.createElement('div');
      form.className = 'grid-two';
      buildForm(item, form, (path,val)=>updateJson(idx, path, val));
      details.appendChild(form);
      editorDiv.appendChild(details);
    });
  }

  function buildForm(obj, parent, onChange, prefix=''){
    Object.entries(obj).forEach(([key, value])=>{
      const path = prefix? prefix+'.'+key : key;
      const wrapper = document.createElement('div');
      const label = document.createElement('label');
      label.textContent = key;
      wrapper.appendChild(label);

      if(Array.isArray(value) && value.every(v=>typeof v==='string')){
        const select = document.createElement('select');
        select.multiple = true;
        select.className='multi-select';
        const unique = [...new Set(value)];
        unique.forEach(opt=>{
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          o.selected = true;
          select.appendChild(o);
        });
        select.addEventListener('change',()=>{
          const selected = Array.from(select.selectedOptions).map(o=>o.value);
          onChange(path,selected);
        });
        wrapper.appendChild(select);
      }else if(typeof value==='string'){
        if(key==='category'){
          const select = document.createElement('select');
          const categories=['challenge','truth','dare','question'];
          categories.forEach(cat=>{
            const o=document.createElement('option');
            o.value=cat;
            o.textContent=cat;
            if(cat===value) o.selected=true;
            select.appendChild(o);
          });
          select.addEventListener('change',()=>onChange(path,select.value));
          wrapper.appendChild(select);
        }else if(isIsoDate(value)){
          const input=document.createElement('input');
          input.type='datetime-local';
          input.value=isoToLocal(value);
          input.addEventListener('input',()=>onChange(path,localToIso(input.value)));
          wrapper.appendChild(input);
        }else{
          const input=document.createElement('input');
          input.type='text';
          input.value=value;
          if(key==='id') input.disabled=true;
          input.addEventListener('input',()=>onChange(path,input.value));
          wrapper.appendChild(input);
        }
      }else if(typeof value==='number'){
        const input=document.createElement('input');
        input.type='number';
        input.value=value;
        input.addEventListener('input',()=>onChange(path,Number(input.value)));
        wrapper.appendChild(input);
      }else if(typeof value==='boolean'){
        const chk=document.createElement('input');
        chk.type='checkbox';
        chk.checked=value;
        chk.addEventListener('change',()=>onChange(path,chk.checked));
        wrapper.appendChild(chk);
      }else if(typeof value==='object' && value!==null){
        const subFieldset=document.createElement('fieldset');
        subFieldset.style.borderLeft='2px solid var(--border)';
        subFieldset.style.paddingLeft='12px';
        buildForm(value, subFieldset, onChange, path);
        wrapper.appendChild(subFieldset);
      }else{
        const textarea=document.createElement('textarea');
        textarea.value=JSON.stringify(value);
        textarea.addEventListener('input',()=>{
          try{
            onChange(path,JSON.parse(textarea.value));
            textarea.style.borderColor='var(--border)';
          }catch{textarea.style.borderColor='red';}
        });
        wrapper.appendChild(textarea);
      }
      parent.appendChild(wrapper);
    });
  }

  function updateJson(idx,path,val){
    const keys=path.split('.');
    let ref=jsonData[idx];
    for(let i=0;i<keys.length-1;i++) ref=ref[keys[i]];
    ref[keys.at(-1)]=val;
  }

  function downloadFile(){
    const blob=new Blob([JSON.stringify(jsonData,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='edited.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function isIsoDate(str){return /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z/.test(str);}  
  function isoToLocal(iso){return new Date(iso).toISOString().slice(0,16);}  
  function localToIso(local){return new Date(local).toISOString();}  
  function isUUID(str){return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(str);}  
})();
</script>
</body>
</html>
